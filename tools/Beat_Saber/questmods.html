<!DOCTYPE html>
<html>
    <head>
        <title>Beat Saber Mod Versions</title>
        <meta property="og:site_name" content="ComputerElite">
        <meta property="og:title" content="Beat Saber Mod Versions" />
        <meta property="og:description" content="Display mods for various game versions" />
        <meta property="og:url" content="https://computerelite.github.io/tools/Beat_Saber/questmods.html" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href="../../css/standard.css" type="text/css" rel="stylesheet">
        <link rel="icon" href="../../assets/CE_64px.png" type="image/x-icon">
        <style>
        td {
            padding: 10px;
        }

        .os {
            font-size: 16px;
            color: #EEE;
        }

        .item {
            flex: 1;
            width: 24%;
            word-wrap: break-word;
            padding: 3px;
            display: inline;
        }
        </style>
    </head>
    <body style="font-size: 14px;">
        <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
            <div style="flex: 1; flex-grow: 0; text-align: center; width: 99%;">
                    <div style="padding: 10px; width: 100%;">
                        <div style="font-size: 24px;">Beat Saber Mod Versions</div>
                        <div class="headerDescription" style="width: 50%; margin: auto;">Pulled from <a href="https://raw.githubusercontent.com/ComputerElite/BM/main/mods.json" target="_blank">BMBF Manager</a></div>
                        <br/>
                        <a style="font-size: 22px; color: #EEEEEE; text-align: center; display: flex; justify-content: center; width: 100%;">
                            Game Version:
                            <select id="gameversion">
                                <option value=""></option>
                            </select>
                        </a>
                        <input type="text" id="search" placeholder="Search mods">
                        <h2>Core Mods</h2>
                        <div id="coremods">

                        </div>
                        <h2>Mods</h2>
                        <div id="mods">

                        </div>
                        <br/>
                    </div>
                    <div style="padding: 5px;">
                        Page by ComputerElite
                    </div>
                </div>
        </div>
        
        <script src="../../js/standard.js"></script>
        <script>
            var org = {}
            var coreOrg = {}
            var gameVersions = {}
            const mods = document.getElementById("mods")
            const coremods = document.getElementById("coremods")
            const gameversion = document.getElementById("gameversion")
            const search = document.getElementById("search")
            const params = new URLSearchParams(window.location.search)
            var displayMethod = params.get("displaymethod") ?? 1

            search.onkeyup = e => {
                Display(gameversion.value)
            }

            PullMods()

            function PullMods() {
                gameVersions = {}
                fetch("https://raw.githubusercontent.com/ComputerElite/BM/main/mods.json").then(res => {
                    res.json().then(json => {
                        org = json
                        SortByGameVersion()
                    })
                })
                fetch("https://raw.githubusercontent.com/BMBF/resources/master/com.beatgames.beatsaber/core-mods.json").then(res => {
                    res.json().then(json => {
                        coreOrg = json
                        SortByGameVersionCore()
                    })
                })
            }

            function SortByGameVersionCore() {
                for (const [key, value] of Object.entries(coreOrg)) {
                    value.mods.forEach(mod => {
                        if(gameVersions[key] == undefined) gameVersions[key] = {mods: [], addedmods: [], coremods: []}
                        gameVersions[key].coremods.push({
                            name: mod.id,
                            ModID: mod.id,
                            version: mod.version,
                            download: mod.downloadLink
                        })
                    })
                }
                AddGameVersions()
                Display(gameversion.value)
            }

            function SortByGameVersion() {
                org.mods.forEach(mod => {
                    var addedGameVersions = []
                    mod.downloads.forEach(download => {
                        download.gameversion.forEach(version => {
                            if(mod && mod.ModID == "CrashMod") {
                                if(!gameVersions["CrashMod"]) gameVersions["CrashMod"] = {mods: [], coremods: []}
                                var m = {
                                    name: mod.name,
                                    details: mod.details,
                                    creator: mod.creator,
                                    ModID: mod.ModID,
                                    version: download.modversion,
                                    download: download.download
                                };
                                gameVersions["CrashMod"].mods.push(m)
                                gameVersions["CrashMod"].coremods.push(m) 
                            }
                            if(!addedGameVersions.includes(version) && (gameVersions[version] == undefined || gameVersions[version].addedmods == undefined || !gameVersions[version].addedmods.includes(mod.id))) {
                                addedGameVersions.push(version)
                                if(gameVersions[version] == undefined) gameVersions[version] = {mods: [], addedmods: [], coremods: []}
                                gameVersions[version].addedmods.push(mod.ModID)
                                gameVersions[version].mods.push({
                                    name: mod.name,
                                    details: mod.details,
                                    creator: mod.creator,
                                    ModID: mod.ModID,
                                    version: download.modversion,
                                    download: download.download
                                })
                            }
                        })
                    })
                });
                gameVersions["CrashMod"].mods.forEach(c => {
                    gameVersions["CrashMod"].mods.forEach(c => {
                        gameVersions["CrashMod"].mods.push(c)
                    })
                })
                AddGameVersions()
                Display(gameversion.value)
            }

            function AddGameVersions() {
                var gameversions = []
                gameversion.innerHTML = ""
                for (const [key, value] of Object.entries(gameVersions)) {
                    if(key != "CrashMod") gameversions.push(key)
                    gameVersions[key].mods.sort(function(a, b) {
                        if(a.name.toLowerCase() < b.name.toLowerCase()) return -1
                        if(b.name.toLowerCase() < a.name.toLowerCase()) return 1
                        return 0
                    })
                    gameVersions[key].coremods.sort(function(a, b) {
                        if(a.name < b.name) return -1
                        if(b.name < a.name) return 1
                        return 0
                    })
                }
                gameversions.sort()
                gameversions.reverse()
                gameversions.push("CrashMod")
                gameversions.forEach(key => {
                    gameversion.innerHTML += `<option value="${key}">${key}</option>`
                })
                if(params.get("version")) {
                    gameversion.value = params.get("version")
                }
            }

            gameversion.onchange = () => {
                Display(gameversion.value)
            }

            function DisplayCards(gameversion) {
                gameversion.innerHTML = "";
                
                var m =``;
                console.log("refreshing for " + gameversion)
                gameVersions[gameversion].mods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase()) || mod.creator.join(", ").toLowerCase().replace(/ /g, '').includes(search.value.toLowerCase().replace(/ /g, ''))) {
                        m +=    `<div style="border-radius: 5px; background-color: #222222BB; padding: 10px; text-align: left;">
                                <h3 style="margin-bottom: 0px; margin-top: 0;">${mod.name}</h3>
                                <div style="margin-top: 0; margin-left: 20px;">by ${mod.creator.join(", ")}. Version ${mod.version}</div>
                                <div style="margin-top: 10px; font-size: 1.2em;">${mod.details.replace(/\n/g, "<br>")}</div>
                                <input onclick="window.open('${mod.download}', '_blank')" type="button" value="Download" style="border-radius: 5px; background-color: #4444FF; color: #EEEEEE; padding: 10px; font-weight: bold;">
                            </div>`
                    }
                })
                mods.innerHTML = ` <div style="display: grid; grid-template-columns: 33% 33% 33%; column-gap: 10px; row-gap: 10px;">
                            ${m}
                        </div>`
                m =``;
                console.log("refreshing for " + gameversion)
                gameVersions[gameversion].coremods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase())) {
                        m +=    `<div style="border-radius: 5px; background-color: #222222BB; padding: 10px; text-align: left;">
                                <h3 style="margin-bottom: 0px; margin-top: 0;">${mod.name}</h3>
                                <div style="margin-top: 0; margin-left: 20px;">Version ${mod.version}</div>
                                <input onclick="window.open('${mod.download}', '_blank')" type="button" value="Download" style="border-radius: 5px; background-color: #4444FF; color: #EEEEEE; padding: 10px; font-weight: bold;">
                            </div>`
                    }
                })
                coremods.innerHTML =` <div style="display: grid; grid-template-columns: 33% 33% 33%; column-gap: 10px; row-gap: 10px;">
                            ${m}
                        </div>`
            }

            function Display(gameversion) {
                if(displayMethod == 1) {
                    DisplayCards(gameversion)
                    return;
                }
                gameversion.innerHTML = "";
                
                var m =``;
                console.log("refreshing for " + gameversion)
                gameVersions[gameversion].mods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase()) || mod.creator.join(", ").toLowerCase().replace(/ /g, '').includes(search.value.toLowerCase().replace(/ /g, ''))) {
                        m +=    `<tr class="hrColorTr pointer" onclick='window.open("${mod.download}", "_blank")'>
                                <td style="vertical-align:top;">${mod.creator.join(", ")}</td>
                                <td><div style="font-size: 120%; font-weight: bold;">${mod.name}</div><div>${mod.details.replace(/\n/g, "<br>")}</div></td>
                                <td style="vertical-align:top;">${mod.version}</td>
                            </tr>`
                    }
                })
                mods.innerHTML = `<table style="color: #EEEEEE; width: 100%; text-align: left; word-wrap: break-word;">
                            <tr>
                                <th style="width: 20%;">Creator(s)</th>
                                <th style="width: 60%;">Name</th>
                                <th style="width: 19%;">Version</th>
                            </tr>
                            ${m}
                        </table>`
                        var m =``;
                console.log("refreshing for " + gameversion)
                gameVersions[gameversion].coremods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase())) {
                        m +=    `<tr class="hrColorTr pointer" onclick='window.open("${mod.download}", "_blank")'>
                                    <td><div style="font-size: 120%; font-weight: bold;">${mod.name}</div></td>
                                    <td>${mod.version}</td>
                                </tr>`
                    }
                })
                coremods.innerHTML =`<table style="color: #EEEEEE; width: 100%; text-align: left; word-wrap: break-word;">
                            <tr>
                                <th style="width: 60%;">Name</th>
                                <th style="width: 19%;">Version</th>
                            </tr>
                            ${m}
                        </table>` 
            }
        </script>
    </body>
</html>