<!DOCTYPE html>
<html>
    <head>
        <title>Beat Saber Mod Versions</title>
        <meta property="og:site_name" content="ComputerElite">
        <meta property="og:title" content="Beat Saber Mod Versions" />
        <meta property="og:description" content="Display mods for various game versions" />
        <meta property="og:url" content="https://computerelite.github.io/tools/Beat_Saber/questmods.html" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,400italic,700,700italic' rel='stylesheet' type='text/css'>
        <link href="../../css/standard.css" type="text/css" rel="stylesheet">
        <link rel="icon" href="../../assets/CE_64px.png" type="image/x-icon">
        <style>

        @media screen and (min-width: 80em) {
            .grid {
                grid-template-columns: 33% 33% 33%;
            }
        }

        @media screen and (max-width: 80em) and (min-width:65em) {
            .grid {
                grid-template-columns: 50% 50%;
            }
        }

        
        @media screen and (max-width: 65em) {
            .grid {
                grid-template-columns: 100%;
            }
        }
        html {
            margin:0;
            padding:0;
            background-image: linear-gradient(rgba(0, 0, 0, 0.5), rgba(0, 0, 0, 0.5)), url('pixelguy.jpg') !important;
            background-blend-mode: unset !important;
            background-attachment: fixed !important;
            background-position: center !important;
        }
        body {
            margin:0;
            padding:1em;
        }

        .button:hover {
            background-image: linear-gradient(135deg, rgba(68, 68, 255, 1) 80%,  rgba(36,36,157,1));
            border-color: white;
        }
        .button {
            margin: 0.2em;
            border-radius: 10px;
            background-color: rgba(0, 0 , 0 , 0);
            background-image: linear-gradient(135deg, rgba(68, 68, 255, 1),  rgba(36,36,157,1));
            border-color: rgba(68, 68, 255, 1);
            border: 1px;
            color: #EEEEEE;
            padding: 1em;
            font-weight: bold;
            user-select: none;
            cursor: pointer;
        }
        a.button:visited {
            color: #EEEEEE;
        }
        td {
            padding: 10px;
        }

        .os {
            font-size: 16px;
            color: #EEE;
        }

        .item {
            flex: 1;
            width: 24%;
            word-wrap: break-word;
            padding: 3px;
            display: inline;
        }

        .mod_modal {
            border-radius: 5px; 
            background-color: rgba(34, 34, 34, 0.831);
            padding: 10px; 
            text-align: left;
            position: relative;
            overflow: hidden;
        }
        .mod_modal:hover {
            background-color: rgba(21, 21, 21, 0.85);
        }

        .mod_highlight::before {
            content: '';
            height: 40px;
            display: block;
            position: absolute;
            top: 0;
            right: 0;
            width: 110px;
            height: 20px;
            transform: translate(30px, 21px) rotate(45deg);
            background-image: linear-gradient( 135deg, #43CBFF 10%, #9708CC 100%);
        }

        .selector {
            padding: 0.5em;
            outline: 0;
            border: 0;
            box-shadow: none;
            background-image: linear-gradient(135deg, rgba(68, 68, 255, 1),  rgba(36,36,157,1));
            background-color: rgba(0, 0 , 0 , 0);
            border: 0;border-radius: 5px;
            color: #eeeeee;
        }

        .selector:hover {
            background-image: linear-gradient(135deg, rgba(68, 68, 255, 1) 80%, rgba(0, 0, 0, 0));
        }

        .selector option {
            color: black;
        }

        #search{
            width: 50%;
            min-width: 6em;
            display: inline-block;
            text-align: center;
            margin: 1em;
        }

        html[data-useragent*='BMBF_Quest'] #coremods {
            display:none;
        }
        html[data-useragent*='BMBF_Quest'] #coreModsText {
            display:none;
        }
        html[data-useragent*='BMBF_Quest'] #core_dl_btn {
            display:none;
        }
        .mod_description {
            margin-bottom: 1em;
            white-space: pre-wrap;
        }
       
        #core_dl_btn {
            display: inline-block;
        }
        </style>
    </head>
    <body style="font-size: 14px;">
        <div style="display: flex; flex-direction: column; width: 100%; height: 100%;">
            <div style="flex: 1; flex-grow: 0; text-align: center; width: 99%;">
                    <div style="padding: 10px; width: 100%;">
                        
                        <div class="attention" style="margin-top: 20px; width: fit-content; font-size: 1.5em;">
                            <div class="attentionHeader" style="font-size: 1.5em;">
                                This site has been made obsolete and will not be updated anymore. Use <a href="https://mods.bsquest.xyz/">the Beat Saber Quest mods page</a> which has taken inspiration from mine
                            </div>
                            If you're seeing this message in QuestAppVersionSwitcher update to the latest version. It has been updated to automatically use the new mods page
                        </div>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <br>
                        <div style="font-size: 24px;">Beat Saber Mod Versions</div>
                        <div class="headerDescription" style="width: 50%; margin: auto;">Pulled from <a href="https://github.com/ComputerElite/ComputerElite.github.io/blob/main/tools/Beat_Saber/mods.json" target="_blank">here</a></div>
                        <div class="headerDescription" style="width: 50%; margin: auto;">Is your mod missing? Add it <a href="modsjsongenerator.html" target="_blank">here.</a></div>
                        <br/>
                        <div id="topStuff">
                            <div style="font-size: 22px; color: #EEEEEE; text-align: center; display: flex; justify-content: center; width: 100%;">
                                <span style="display: block; margin-right:1em;">Game Version</span><br />
                                <select id="gameversion" class="selector">
                                    <option value=""></option>
                                </select>
                            </div>
                            <input type="text" id="search" placeholder="Search mods"> <br />
                            <a id="core_dl_btn" class="button" target="_blank">Download all core mods</a>
                        </div>
                        
                        <h2 id="coreModsText">Core Mods</h2>
                        <div id="coremods">
                            <h3>Loading....</h3>
                        </div>
                        <h2 id="modsHeader">Mods</h2>
                        <div id="mods">
                            <h3>Loading....</h3>
                        </div>
                        <br/>
                    </div>
                    <div style="padding: 5px;">
                        Page by ComputerElite<br />
                        Design by Alteran<br />
                        Beat Saber render provided by Pixelguy
                    </div>
                </div>
        </div>
        
        <script src="../../js/standard.js"></script>
        <script>
            location.href = `https://mods.bsquest.xyz/qavs/?${location.href.split("?")[1] || ""}`;
            var b = document.documentElement;
            b.setAttribute('data-useragent',  navigator.userAgent);
            b.setAttribute('data-platform', navigator.platform );
            b.className += ((!!('ontouchstart' in window) || !!('onmsgesturechange' in window))?' touch':'');
            var org = {}
            var coreOrg = {}
            var gameVersions = {}
            const mods = document.getElementById("mods")
            const coremods = document.getElementById("coremods")
            const gameversion = document.getElementById("gameversion")
            const search = document.getElementById("search")
            const params = new URLSearchParams(window.location.search)
            const coreModsText = document.getElementById("coreModsText")
            const topStuff = document.getElementById("topStuff")
            var displayMethod = params.get("displaymethod")
            if(!displayMethod) displayMethod = 1
            var coreModsLoaded = false
            var displayCovers = params.get("covers")
            var modloader = params.get("modloader")
            //if(modloader) document.getElementById("modloader").value = modloader

            if(params.get("isqavs") && params.get("ismodded")) {
                //document.getElementById("modloadercontainer").style.display = "none"
            }

            /*
            document.getElementById("modloader").onchange = () => {
                modloader = document.getElementById("modloader").value
                Display(gameversion.value)
            }
            */

            var bypass = false
           
            var firstVisit = false
            /**
            * Stores all downloaded mods
            * @type {string} url
            */
            var existing = []
            if(localStorage.oldMods) {
                existing = JSON.parse(localStorage.oldMods);
            } else {
                firstVisit = true
                localStorage.oldMods = JSON.stringify(existing)
            }

            search.onkeyup = e => {
                if(gameversion.value == "undefined") return
                Display(gameversion.value)
            }
            PullMods()

            function PullMods() {
                gameVersions = {}
                // Fetch core mods, then normal mods
                PullCoreMods()
                PullNormalMods()
            }

            function PullCoreMods() {
	            fetch("coreMods.json").then(res => {
                    res.json().then(json => {
                        coreOrg = json
                        coreModsLoaded = true
                        SortByGameVersionCore()
                        SortByGameVersion()
                    })
                })
            }

            function PullNormalMods() {
                fetch("mods.json").then(res => {
                    res.json().then(json => {
                        org = json
                        SortByGameVersion()
                    })
                })
            }

            function compareVersions(version1, version2) {
                const parts1 = version1.split('_')[0].split('.').map(Number);
                const parts2 = version2.split('_')[0].split('.').map(Number);

                for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
                    const part1 = parts1[i] || 0;
                    const part2 = parts2[i] || 0;

                    if (part1 < part2) {
                        return -1;
                    } else if (part1 > part2) {
                        return 1;
                    }
                }

                return 0;
            }

            function GetModloaderBasedOnVersion(version) {
                return compareVersions("1.28.0", version) == -1 ? "Scotland2" : "QuestLoader"
            }

            function SortByGameVersionCore() {
                for(const [key, value] of Object.entries(coreOrg)) {
                    if(!gameVersions[key]) gameVersions[key] = {
                        coremods: [],
                        mods: []
                    }
                    for(const coremod of value.mods) {
                        // Adapt core mods format to normal mods format
                        var mod = {
                            name: coremod.id,
                            id: coremod.id,
                            version: coremod.version,
                            download: coremod.downloadLink,
                            description: "",
                            author: "unknown",
                            modloader: GetModloaderBasedOnVersion(key)
                        }
                        if(firstVisit) AddDownloadedMod(mod.download)
                        if(gameVersions[key].coremods.map(x => x.id).includes(mod.id)) {
                            var existingMod = gameVersions[key].coremods[gameVersions[key].coremods.map(x => x.id).indexOf(mod.id)]
                            if(compare(mod.version, existingMod.versions[0].version) >= 0) {
                                existingMod.download = mod.download
                                existingMod.versions.unshift({version: mod.version, download: mod.download})
                            } else if(compare(mod.version, existingMod.versions[0].version) < 0) {
                                existingMod.versions.push({version: mod.version, download: mod.download})
                            }
                        } else {
                            mod.versions = [{version: mod.version, download: mod.download}]
                            gameVersions[key].coremods.push(mod)
                        }
                    }
                }
                if(firstVisit) localStorage.oldMods = JSON.stringify(existing)
                AddGameVersions()
                Display(gameversion.value)
            }

            var hiddenGameVersions = []

            function SortByGameVersion() {
                for(const [key, value] of Object.entries(org)) {
                    if(!gameVersions[key]) gameVersions[key] = {
                        coremods: [],
                        mods: []
                    }
                    gameVersions[key].mods = []
                    var Mods = []
                    var coreMods = []
                    for(const mod of value) {
                        if(firstVisit) AddDownloadedMod(mod.download)

                        // If mod is core mod, add it to core mods
                        if(gameVersions[key].coremods.map(x => x.id).includes(mod.id)) {
                            var existingMod = gameVersions[key].coremods[gameVersions[key].coremods.map(x => x.id).indexOf(mod.id)]
                            
                            if(compare(mod.version, existingMod.versions[0].version) >= 0) {
                                existingMod.author = mod.author
                                existingMod.download = mod.download
                                existingMod.versions.unshift({version: mod.version, download: mod.download})
                            } else if(compare(mod.version, existingMod.versions[0].version) < 0) {
                                existingMod.versions.push({
                                    version: mod.version, 
                                    download: mod.download,
                                    author: mod.author
                                })
                            }
                        } else {
                            if(Mods.map(x => x.id).includes(mod.id)) {
                                if (mod.author.includes("FrozenAlex")) {
                                    console.log("Adding mod " + mod.name + " to mods", 'Version: ' + mod.version, 'Download: ' + mod.download, 'Author: ' + mod.author)
                                };
                                const existingMod = Mods[Mods.map(x => x.id).indexOf(mod.id)]
                                
                                if(compare(mod.version, existingMod.versions[0].version) >= 0) {
                                    existingMod.author = mod.author
                                    existingMod.download = mod.download
                                    existingMod.versions.unshift({version: mod.version, download: mod.download})
                                } else if(compare(mod.version, existingMod.versions[0].version) < 0) {
                                    existingMod.versions.push({version: mod.version, download: mod.download})
                                }
                            } else {
                                mod.versions = [{
                                    version: mod.version, 
                                    download: mod.download,
                                    author: mod.author
                                }]
                                Mods.push(mod)
                            }
                        }
                        
                    }
                    gameVersions[key].mods = Mods
                }
                if(firstVisit) localStorage.oldMods = JSON.stringify(existing)
                var versionInLocastorage = localStorage.gameversion
                AddGameVersions()
                var foundMatchingGameversion = false
                for (let checkVersion in gameVersions) {
                    let urlVersion = params.get("version")
                    if (checkVersion.includes(urlVersion)) {
                        foundMatchingGameversion = true
                        gameversion.value = checkVersion
                        localStorage.gameversion = checkVersion
                    }
                }
                if(!foundMatchingGameversion && params.get("isqavs") && !bypass) {
                    coremods.innerHTML =`
                        <div class="attention" style="margin-bottom: 20px; margin-left: 50%; transform: translate(-50%, 0%); font-size: 2em">
                            Your installed Beat Saber version <b>does not</b> support any mods. <b>Downgrade</B> to a version which supports mods.
                            <br>
                            <br>
                            Your game version: <code>${params.get("version")}</code>
                            <br>
                            The latest supported gameversion is <code>${GetLatestGameVersion()}</code>. To get this version press the button below.
                            <br>
                            <input class="button" type="button" style="font-size: 1.1em" onclick="location = 'http://127.0.0.1:${params.get("port")}?download=true&version=${GetLatestGameVersion()}&game=2448060205267927'" value="Download latest moddable game version">
                            <br>
                            <br>
                            <i style="font-size: .7em;">Use the <code>QuestAppVersionSwitcher</code> button at the top right to get back to the main menu</i>
                            <br>
                            <i style="font-size: .7em;"><a onclick="bypass = true; PullMods()">View mods anyway</a></i>
                        </div>` 
                    mods.innerHTML =``
                    modsHeader.style.display = "none"
                    coreModsText.style.display = "none"
                    topStuff.style.display = "none"
                    return
                }
                if(params.get("isqavs") && (params.get("ismodded") && params.get("ismodded").toLowerCase() == "false") && !bypass) {
                    coremods.innerHTML =`
                        <div class="attention" style="margin-bottom: 20px; margin-left: 50%; transform: translate(-50%, 0%); font-size: 2em">
                            Your Beat Saber game is not modded yet. To mod it press the button below.
                            <input class="button" type="button" style="font-size: 1.1em" onclick="location = 'http://127.0.0.1:${params.get("port")}?package=com.beatgames.beatsaber&modnow=true'" value="Mod my game">
                            <br>
                            <br>
                            <i style="font-size: .7em;">Use the <code>QuestAppVersionSwitcher</code> button at the top right to get back to the main menu</i>
                            <br>
                            <i style="font-size: .7em;"><a onclick="bypass = true; PullMods()">View mods anyway</a></i>
                        </div>
                    `
                    mods.innerHTML =``
                    modsHeader.style.display = "none"
                    coreModsText.style.display = "none"
                    topStuff.style.display = "none"
                    return
                }
                if(!foundMatchingGameversion && (!versionInLocastorage || versionInLocastorage == "undefined")) {
                    coremods.innerHTML =`<h1 style="background-color: #232323; padding: 20px; font-size: 3em">Select a game version</h1>` 
                        mods.innerHTML =``
                    gameversion.innerHTML = `<option value="undefined">Select a game version</option>` + gameversion.innerHTML
                    gameversion.value = "undefined"
                    localStorage.gameversion = undefined
                    return
                }
                if(versionInLocastorage) gameversion.value = versionInLocastorage
                Display(gameversion.value)
            }

            function GetLatestGameVersion() {
                var gameversions = []
                gameversion.innerHTML = ""
                for (const [key, value] of Object.entries(gameVersions)) {
                    if(key == "undefined") continue;
                    if(hiddenGameVersions.includes(key)) continue;
                    gameversions.push(key)
                    gameVersions[key].mods.sort(function(a, b) {
                        if(a.name.toLowerCase() < b.name.toLowerCase()) return -1
                        if(b.name.toLowerCase() < a.name.toLowerCase()) return 1
                        return 0
                    })
                    gameVersions[key].coremods.sort(function(a, b) {
                        if(a.name < b.name) return -1
                        if(b.name < a.name) return 1
                        return 0
                    })
                }
                gameversions.sort()
                gameversions.reverse()
                return gameversions[0]
            }
            
            function AddGameVersions() {
                var gameversions = []
                gameversion.innerHTML = ""
                for (const [key, value] of Object.entries(gameVersions)) {
                    if(key == "undefined") continue;
                    gameversions.push(key)
                    gameVersions[key].mods.sort(function(a, b) {
                        if(a.name.toLowerCase() < b.name.toLowerCase()) return -1
                        if(b.name.toLowerCase() < a.name.toLowerCase()) return 1
                        return 0
                    })
                    gameVersions[key].coremods.sort(function(a, b) {
                        if(a.name < b.name) return -1
                        if(b.name < a.name) return 1
                        return 0
                    })
                }
                gameversions.sort()
                gameversions.reverse()
                gameversions.forEach(key => {
                    if (gameVersions[key].coremods.length === 0 && !params.has("showall")) return;
                    if(hiddenGameVersions.includes(key)) return
                    gameversion.innerHTML += `<option value="${key}">${key}</option>`
                })
                if(params.get("version") && gameversions.includes(params.get("version"))) {
                    gameversion.value = params.get("version")
                }
            }

            gameversion.onchange = () => {
                if(!localStorage.gameversion || localStorage.gameversion == "undefined") AddGameVersions()
                localStorage.gameversion = gameversion.value
                Display(gameversion.value)
            }

            function GetModButtons(mod, isCore) {
                var downloadLink = mod.download
                var githubLink = ""
                if(downloadLink.includes("github.com")) {
                    githubLink = downloadLink.substring(0, downloadLink.indexOf("releases"))
                }

                return `
                    <a href="${downloadLink}" class="button downloadButton">Download</a>
                    ${githubLink ? `
                        <a class="button" href="${githubLink}issues" target="_blank">Report Bug</a>
                        <a class="button" href="${githubLink}" target="_blank">Open GitHub Repository</a>
                    ` : ""}
                    ${isCore ? `` : `
                        <input type="button" value="Mark" class="button markButton">
                    `}
                `
            }

            function AddDownloadedMod(link) {
                if(!existing.includes(link)) existing.push(link)
            }

            /**
            * @param {string} modId
            * @param {boolean} toggle 
            */
            function MarkAsDownloaded(modId, toggle = false) {
                if (!localStorage.oldMods) localStorage.oldMods = []
                
                var toConcat = []
                existing = JSON.parse(localStorage.oldMods)
                for (const d of [...document.getElementById(modId).options].map(o => o.value)) {
                    if (!existing.includes(d)) toConcat.push(d)
                }
                
                if (toConcat.length > 0) {
                    // Add mods to marked
                    existing = existing.concat(toConcat)
                } else if (toggle) {
                    // Remove mods from marked
                    for (const d of [...document.getElementById(modId).options].map(o => o.value)) {
                        if (existing.includes(d)) existing = existing.filter(e => e != d)
                    }
                }
                localStorage.oldMods = JSON.stringify(existing)

                Display(gameversion.value)
            }

            function GetModType(mod) {
                if(mod.modloader == "Scotland2") return "Scotland2"
                if(mod.modloader == "QuestLoader" || !mod.modloader) return "QuestLoader"
            }
            
            /**
            * Makes a string searchable by removing spaces and making it lowercase
            * @param {string} str
            */
            function toSearchableString(str) {
                return str.toLowerCase().replace(/ /g, '').toLowerCase().trim()
            }

            function ShowMod(mod) {
                /*
                if(modloader) {
                    // Don't show mods with another modloader
                    if(modloader == "QuestLoader" && mod.modloader != "QuestLoader" && mod.modloader) return false
                    if(modloader == "Scotland2" && mod.modloader != "Scotland2") return false
                }
                */
                
                /**
                * @type {string}
                */ 
                const searchValue = toSearchableString(search.value)

                if (searchValue) {
                    if (!(
                        toSearchableString(mod.name).includes(searchValue) ||
                        toSearchableString(mod.id).includes(searchValue) ||
                        toSearchableString(mod.author).includes(searchValue) ||
                        toSearchableString(mod.description ? mod.description : "").includes(searchValue)
                    )) return false;
                }

                return true
            }
            
            function OnModVersionSelect(e){
                const modContainer = e.currentTarget.closest(".mod_modal")
                const downloadButton = modContainer.querySelector(".downloadButton")
                const modId = modContainer.getAttribute("data-modid")
                    
                // Get selected version from dropdown
                const this_gameversion = gameversion.value
                
                // Find mod
                let mod = gameVersions[this_gameversion].mods.find(m => m.id == modId)
                if(!mod) mod = gameVersions[this_gameversion].coremods.find(m => m.id == modId)
                if (!mod) return console.error("Mod not found");

                // Find version
                const version = mod.versions.find(v => v.download == e.target.value)
                downloadButton.setAttribute("href", version.download)
            }

            function OnModDownloadClick(e) {
                const modContainer = e.currentTarget.closest(".mod_modal")
                const downloadButton = modContainer.querySelector(".downloadButton")
                const modId = modContainer.getAttribute("data-modid")
                
                MarkAsDownloaded(modId)    
            }

            function OnModMarkClick(e) {
                const modContainer = e.currentTarget.closest(".mod_modal")
                const downloadButton = modContainer.querySelector(".downloadButton")
                const modId = modContainer.getAttribute("data-modid")

                MarkAsDownloaded(modId, true)
            }

            function DisplayCards(this_gameversion) {
                this_gameversion.innerHTML = "";

                // Mods
                {
                    // Create container for all elements
                    let container = document.createElement("div")
                    container.className = "grid"

                    console.log("refreshing for " + this_gameversion)
                    var modsToShow = [...gameVersions[this_gameversion].mods]
                    /*
                    // Ignore versions without specific version
                    if(gameVersions["undefined"]) {
                        for(const m of gameVersions["undefined"].mods) {
                            modsToShow.push(m)
                        }
                    }
                    */
                    modsToShow.sort(function(a, b) {
                        if(a.name.toLowerCase() < b.name.toLowerCase()) return -1
                        if(b.name.toLowerCase() < a.name.toLowerCase()) return 1
                        return 0
                    })
                    modsToShow.forEach(mod => {
                        // Handle search
                        if(!ShowMod(mod)) return
                        
                        // Handle github links
                        var githubLink = ""
                        if(mod.download.includes("github.com")) {
                            githubLink = mod.download.substring(0, mod.download.indexOf("releases"))
                        }

                        // Create version dropdown
                        var versionDropDown = `<select class='selector' id="${mod.id}">`
                        mod.versions = mod.versions.sort(function(a, b) {
                            if(compare(a.version, b.version) > 0) return -1
                            if(compare(a.version, b.version) < 0) return 1
                            return 0
                        })
                        var isNew = false
                        for(const v of mod.versions) {
                            if(!existing.includes(v.download)) isNew = true
                            versionDropDown += `<option value="${v.download}" >${v.version}</option>`
                        }
                        versionDropDown += `</select>`
                        
                        // Render item
                        var item = document.createElement("div")
                        item.classList.add("mod_modal")
                        item.setAttribute("data-modid", mod.id)
                        isNew && item.classList.add("mod_highlight")
                        if (mod.cover && displayCovers) {
                            item.style.backgroundImage = `url('${mod.cover}')`
                            item.style.backgroundBlendMode = "color"
                            item.style.backgroundSize = "cover"
                            item.style.backgroundRepeat = "no-repeat"
                            item.style.backgroundPosition = "center"
                        }
                        
                        item.innerHTML =   `
                            <i style="margin-bottom: 5px; margin-top: 0; color: #FFFFFF66">${GetModType(mod)}</i>
                            <h3 style="margin-bottom: 0px; margin-top: 0;">${mod.name}</h3>
                            <div style="margin-top: 0; margin-left: 20px;">by ${mod.author}. Version ${versionDropDown}</div>
                            <div class="mod_description" style="margin-top: 10px; font-size: 1.2em;">${mod.description ? mod.description : ""}</div>
                            ${GetModButtons(mod, false)}
                        `

                        // Add listeners
                        const downloadButton = item.querySelector(".downloadButton")
                        downloadButton.addEventListener("click", OnModDownloadClick)
                        const selector = item.querySelector(".selector")
                        selector && selector.addEventListener("change", OnModVersionSelect)
                        const markButton = item.querySelector(".markButton")
                        markButton && markButton.addEventListener("click", OnModMarkClick)

                        container.appendChild(item)
                    })

                    // Refresh mods container
                    mods.innerHTML = ``
                    mods.appendChild(container)
                }
                
                // Core mods
                {
                    let container = document.createElement("div")
                    container.className = "grid"
                    gameVersions[this_gameversion].coremods.forEach(mod => {
                        // Handle search
                        if(!ShowMod(mod)) return

                        var githubLink = ""
                        if(mod.download.includes("github.com")) {
                            githubLink = mod.download.substring(0, mod.download.indexOf("releases"))
                        }

                        var versionDropDown = `<select class='selector' id="${mod.id}">`
                        mod.versions = mod.versions.sort(function(a, b) {
                            if(compare(a.version, b.version) > 0) return -1
                            if(compare(a.version, b.version) < 0) return 1
                            return 0
                        })
                        var isNew = false
                        for(const v of mod.versions) {
                            if(!existing.includes(v.download)) isNew = true
                            versionDropDown += `<option value="${v.download}">${v.version}</option>`
                        }
                        versionDropDown += `</select>`
                        
                        var item = document.createElement("div")
                        item.setAttribute("data-modid", mod.id)
                        item.classList.add("mod_modal")
                        isNew && item.classList.add("mod_highlight")
                        
                        item.innerHTML = `
                            <i style="margin-bottom: 5px; margin-top: 0; color: #FFFFFF66">${GetModType(mod)}</i>
                            <h3 style="margin-bottom: 0px; margin-top: 0;">${mod.name}</h3>
                            <div style="margin-top: 0; margin-left: 20px;">by ${mod.author}. Version ${versionDropDown}</div>
                            <div class="mod_description" style="margin-top: 10px; font-size: 1.2em;">${mod.description.replace(/\n/g, "<br>")}</div>
                            ${GetModButtons(mod, false)}
                        `
                        
                        // Add listeners
                        const downloadButton = item.querySelector(".downloadButton")
                        downloadButton.addEventListener("click", OnModDownloadClick)
                        const selector = item.querySelector(".selector")
                        selector && selector.addEventListener("change", OnModVersionSelect)
                        const markButton = item.querySelector(".markButton")
                        markButton && markButton.addEventListener("click", OnModMarkClick)
                        
                        container.appendChild(item)
                    })
                    coremods.innerHTML =``
                    coremods.appendChild(container)
                    coreModsText.innerHTML = coreModsLoaded ? (container.children.length ? "Core Mods" : "No core mods for this version") : "Loading...."
                }
            }

            function FuckYouKrak(this_gameversion) {
                gameVersions[this_gameversion].mods = []
                gameVersions[this_gameversion].coremods = []
                const fuckYouKrak =  {
                                    name: "Fuck you KRAK",
                                    details:"Fuck you KRAK",
                                    creator: ["Fuck", "you", "KRAK"],
                                    ModID: "Fuck you KRAK",
                                    version: "Fuck you KRAK",
                                    download: "/redirect?target=self&random",
                                }
                for(let i = 0; i < 40; i++) {
                    gameVersions[this_gameversion].mods.push(fuckYouKrak)
                    gameVersions[this_gameversion].coremods.push(fuckYouKrak)
                }
            }

            function Display(this_gameversion) {
                // Update download all cores link
                const allCoresLink = document.getElementById("core_dl_btn");
                console.log(allCoresLink)
                if (allCoresLink) {
                    if (this_gameversion) {
                        allCoresLink.setAttribute(
                            "href", 
                            `https://oculusdb.rui2015.me/api/coremodsdownload/${this_gameversion}.qmod`
                        )
                    }
                }

                if(displayMethod == 1) {
                    DisplayCards(this_gameversion)
                    return;
                } else if(displayMethod != 69) {
                    FuckYouKrak(this_gameversion)
                }
                this_gameversion.innerHTML = "";
                
                var m =``;
                console.log("refreshing for " + this_gameversion)
                gameVersions[this_gameversion].mods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase()) || mod.creator.join(", ").toLowerCase().replace(/ /g, '').includes(search.value.toLowerCase().replace(/ /g, ''))) {
                        m +=    `<tr class="hrColorTr pointer" onclick='window.open("${mod.download}", "_blank")'>
                                <td style="vertical-align:top;">${mod.author}</td>
                                <td><div style="font-size: 120%; font-weight: bold;">${mod.name}</div><div>${mod.description.replace(/\n/g, "<br>")}</div></td>
                                <td style="vertical-align:top;">${mod.version}</td>
                            </tr>`
                    }
                })
                mods.innerHTML = `<table style="color: #EEEEEE; width: 100%; text-align: left; word-wrap: break-word;">
                            <tr>
                                <th style="width: 20%;">Creator(s)</th>
                                <th style="width: 60%;">Name</th>
                                <th style="width: 19%;">Version</th>
                            </tr>
                            ${m}
                        </table>`
                        var m =``;
                console.log("refreshing for " + this_gameversion)
                gameVersions[this_gameversion].coremods.forEach(mod => {
                    if(mod.name.toLowerCase().replace(/ /g, '').includes(search.value.replace(/ /g, '').toLowerCase())) {
                        m +=    `<tr class="hrColorTr pointer" onclick='window.open("${mod.download}", "_blank")'>
                                    <td><div style="font-size: 120%; font-weight: bold;">${mod.name}</div></td>
                                    <td>${mod.version}</td>
                                </tr>`
                    }
                })
                coremods.innerHTML =`<table style="color: #EEEEEE; width: 100%; text-align: left; word-wrap: break-word;">
                            <tr>
                                <th style="width: 60%;">Name</th>
                                <th style="width: 19%;">Version</th>
                            </tr>
                            ${m}
                        </table>` 
            }

            function ConvertJSON() {
                var res = {}
                for (const [key, value] of Object.entries(gameVersions)) {
                    res[key] = []
                    total += gameVersions[key].mods.length
                    for(const mod of gameVersions[key].mods) {
                        var githubLink = null
                        if(mod.download.includes("github.com")) {
                            githubLink = mod.download.substring(0, mod.download.indexOf("releases"))
                        }
                        res[key].push({
                            name: mod.name,
                            description: mod.details,
                            id: mod.ModID,
                            version: mod.version,
                            download: mod.download,
                            source: githubLink,
                            author: mod.creator.join(", "),
                            forward: mod.forward
                        })
                    }  
                }
                console.log(JSON.stringify(res))
            }

            var done = 0
            var total = 0
            var res = {}
            async function GetModJSON() {
                done = 0
                total = 0
                for (const [key, value] of Object.entries(gameVersions)) {
                    res[key] = []
                    total += gameVersions[key].mods.length
                    gameVersions[key].mods.forEach(async mod => {
                        var githubLink = ""
                        if(mod.download.includes("github.com")) {
                            githubLink = mod.download.substring(0, mod.download.indexOf("releases"))
                        } else {
                            ModDone(mod)
                            return
                        }
                        var rawLink = `https://raw.githubusercontent.com/${githubLink.split("/")[3]}/${githubLink.split("/")[4]}/`
                        var coverUrl = ""
                        var modUrl = ""
                        if(await DoesUrlExist(rawLink + "main/mod.json")) modUrl = rawLink + "main/mod.json"
                        else if(await DoesUrlExist(rawLink + "main/mod.template.json")) modUrl = rawLink + "main/mod.template.json"
                        else if(await DoesUrlExist(rawLink + "master/mod.json")) modUrl = rawLink + "master/mod.json"
                        else if(await DoesUrlExist(rawLink + "master/mod.template.json")) modUrl = rawLink + "master/mod.template.json"
                        else {
                            ModDone(mod)
                            return
                        }
                        var modJson = await (await fetch(modUrl)).json()
                        if(await DoesUrlExist(rawLink + "master/" + modJson.coverImage)) coverUrl = rawLink + "master/" + modJson.coverImage
                        else if(await DoesUrlExist(rawLink + "main/" + modJson.coverImage)) coverUrl = rawLink + "main/" + modJson.coverImage
                        else {
                            ModDone(mod)
                            return
                        }
                        res[key].push({
                            name: mod.name,
                            description: mod.details,
                            id: mod.ModID,
                            version: mod.version,
                            downloadLink: mod.download,
                            source: githubLink,
                            cover: coverUrl,
                            author: {
                                name: mod.creator.join(", "),
                                icon: `https://avatars.githubusercontent.com/${githubLink.split("/")[3]}`
                            }
                        })
                        
                        ModDone(mod)
                    }) 
                }
            }

            function ModDone(mod) {
                done++
                console.log(mod.name + " v " + mod.version + " done")
                if(done == total) {
                    console.log(res)
                    console.log(JSON.stringify(res))
                }
            }

            function MergeModJSON() {
                var res2 = {}
                fetch(`https://raw.githubusercontent.com/QuestModding/QuestBeatSaberModsRepo/master/mods.json`).then(m => {
                    m.json().then(m => {
                        var keys = []
                        for(const [key, value] of Object.entries(m)) {
                            if(!keys.includes(key)) keys.push(key)
                        }
                        for(const [key, value] of Object.entries(res)) {
                            if(!keys.includes(key)) keys.push(key)
                        }
                        console.log("hello " + keys.length)
                        for(const v of keys) {
                            console.log(v)
                            res2[v] = []
                            if(!m[v]) {
                                // online json doesn't have game version
                                res2[v] = res[v]
                                continue
                            } else if(!res[v]) {
                                // offline json doesn't have game version
                                res2[v] = m[v]
                                continue
                            }
                            var modIds = []
                            for(const mod of res[v]) {
                                if(!modIds.includes(mod.id)) modIds.push(mod.id)
                            }
                            for(const mod of m[v]) {
                                if(!modIds.includes(mod.id)) modIds.push(mod.id)
                            }

                            for(const id of modIds) {
                                var online = GetMod(id, m[v])
                                var offline = GetMod(id, res[v])
                                if(!online) {
                                    res2[v].push(offline)
                                    continue
                                }
                                else if(!offline) {
                                    res2[v].push(online)
                                    continue
                                }
                                if(compare(online.version.split("-")[0], offline.version.split("-")[0]) >= 0) {
                                    res2[v].push(online)
                                } else {
                                    res2[v].push(offline)
                                }
                            }
                        }
                        console.log(res2)
                        console.log(JSON.stringify(res2))
                    })
                })
            }

            function GetMod(id, array) {
                for(const mod of array) {
                    if(mod.id == id) return mod
                }
                return null
            }

            // Return 1 if a > b
            // Return -1 if a < b
            // Return 0 if a == b
            function compare(a, b) {
                if (a === b) {
                return 0;
                }

                var a_components = a.split(".");
                var b_components = b.split(".");

                var len = Math.min(a_components.length, b_components.length);

                // loop while the components are equal
                for (var i = 0; i < len; i++) {
                    // A bigger than B
                    if (parseInt(a_components[i]) > parseInt(b_components[i])) {
                        return 1;
                    }

                    // B bigger than A
                    if (parseInt(a_components[i]) < parseInt(b_components[i])) {
                        return -1;
                    }
                }

                // If one's a prefix of the other, the longer one is greater.
                if (a_components.length > b_components.length) {
                    return 1;
                }

                if (a_components.length < b_components.length) {
                    return -1;
                }

                // Otherwise they are the same.
                return 0;
            }

            function DoesUrlExist(url) {
                return new Promise((resolve, reject) => {
                    fetch(url).then(res => {
                        if(res.status == 200) resolve(true)
                        else resolve(false)
                    })
                })
            }
        </script>
    </body>
</html>
